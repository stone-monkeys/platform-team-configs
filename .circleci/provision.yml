version: 2.1

# Define the orbs we'll use
orbs:
  terraform: circleci/terraform@3.6
  aws-cli: circleci/aws-cli@5.4.0
  gh: circleci/github-cli@2.2
  platform-team: https://raw.githubusercontent.com/stone-monkeys/platform-team-configs/refs/heads/main/orbs/platform-team.yml

parameters:
  template_repo:
    type: string
    description: "Template repository to use as base"
    default: ""
  target_repo:
    type: string
    description: "Target repository where infrastructure will be provisioned"
    default: ""

jobs:
  configure-cci:
    docker:
      - image: cimg/deploy:2025.01.1
    environment:
      WEBHOOK_BODY: << pipeline.trigger_parameters.webhook.body >>
    steps:
      - checkout
      - platform-team/parse-webhook-payload
      # - platform-team/build-terraform-provider-circleci:
      #     provider_version: "0.2.0"
      - platform-team/setup-tf-vars
      - aws-cli/setup:
          role_arn: "arn:aws:iam::${AWS_ACCOUNT_ID}:role/${AWS_IAM_PREFIX}"
          role_session_name: "fe-provider-demo-<< pipeline.number >>"
      - run:
          name: Generate backend config
          command: |
            echo "key=\"platform-team-configs/port/${TARGET_REPO}.tfstate\"" > terraform/pipeline-terraform/backend.conf
      - terraform/apply:
          backend_config_file: backend.conf
          path: terraform/pipeline-terraform
          var_file: app.tfvars
      - gh/setup
      - run:
          name: Trigger initial CI/CD pipeline with empty commit
          command: |
            # Use GitHub CLI to clone (handles auth automatically) and create empty commit
            gh repo clone ${GITHUB_ORG}/${TARGET_REPO} /tmp/trigger-repo -- --depth=1
            cd /tmp/trigger-repo
            
            # Configure git for the commit
            git config user.name "Platform Team Bot"
            git config user.email "platform-team@circleci.com"
            
            # Create and push empty commit to trigger CI/CD
            git commit --allow-empty -m "chore: trigger initial CI/CD pipeline

            This empty commit was created automatically by the platform team
            to trigger the initial CI/CD pipeline for this repository."
            
            # Push using GitHub CLI (handles auth)
            git push origin main

  configure-cci-from-ui:
    docker:
      - image: cimg/deploy:2025.01.1
    environment:
      TEMPLATE_REPO: << pipeline.parameters.template_repo >>
      TARGET_REPO: << pipeline.parameters.target_repo >>
      TF_LOG: TRACE
      TF_LOG_PATH: /tmp/terraform.log
    steps:
      - checkout
      - platform-team/parse-webhook-payload
      # - platform-team/build-terraform-provider-circleci:
      #     provider_version: "0.2.0"
      - platform-team/setup-tf-vars
      - aws-cli/setup:
          role_arn: "arn:aws:iam::${AWS_ACCOUNT_ID}:role/${AWS_IAM_PREFIX}"
          role_session_name: "fe-provider-demo-<< pipeline.number >>"
      - run:
          name: Generate backend config
          command: |
            echo "key=\"platform-team-configs/port/${TARGET_REPO}.tfstate\"" > terraform/pipeline-terraform/backend.conf
      - terraform/init:
          backend_config_file: backend.conf
          path: terraform/pipeline-terraform
      - terraform/apply:
          backend_config_file: backend.conf
          path: terraform/pipeline-terraform
          var_file: app.tfvars
      - run:
          name: "Capture Terraform logs for debugging"
          command: |
            if [ -f /tmp/terraform.log ]; then
              echo "=== TERRAFORM TRACE LOGS ==="
              cat /tmp/terraform.log
            fi
      - gh/setup
      - run:
          name: Trigger initial CI/CD pipeline with empty commit
          command: |
            # Use GitHub CLI to clone (handles auth automatically) and create empty commit
            gh repo clone ${GITHUB_ORG}/${TARGET_REPO} /tmp/trigger-repo -- --depth=1
            cd /tmp/trigger-repo
            
            # Configure git for the commit
            git config user.name "Platform Team Bot"
            git config user.email "platform-team@circleci.com"
            
            # Create and push empty commit to trigger CI/CD
            git commit --allow-empty -m "chore: trigger initial CI/CD pipeline

            This empty commit was created automatically by the platform team
            to trigger the initial CI/CD pipeline for this repository."
            
            # Push using GitHub CLI (handles auth)
            git push origin main

workflows:
  provision-infrastructure:
    when:
      and:
        - equal: [ webhook, << pipeline.trigger_source >> ]
        - << pipeline.trigger_parameters.webhook.body >>
    jobs:
      - configure-cci:
          context: 
            - centralized-asset-github-envs

  provision-infrastructure-via-circleci:
    when:
      and:
        - equal: [ api, << pipeline.trigger_source >> ]
        - << pipeline.parameters.target_repo >>
    jobs:
      - configure-cci-from-ui:
          context: 
            - centralized-asset-github-envs
